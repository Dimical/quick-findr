import { Button, LineEdit, ScrollView, ListView, CheckBox, ComboBox } from "std-widgets.slint";

export struct SearchResult {
    file_name: string,
    file_path: string,
    relative_path: string,
    extension: string,
    line_match: string,
    icon_color: color,
}

export struct FavoriteFolder {
    path: string,
    name: string,
    is_favorite: bool,
}

component MenuItem inherits Rectangle {
    in property <string> text;
    in property <string> icon: "";
    callback clicked();
    
    height: 32px;
    background: touch.has-hover ? #383838 : transparent;
    border-radius: 4px;
    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding-left: 12px;
        padding-right: 12px;
        spacing: 8px;
        
        if (root.icon != "") : Text {
            text: root.icon;
            font-family: "Segoe UI Emoji";
            color: #60CDFF;
            vertical-alignment: center;
            font-size: 14px;
            width: 16px;
        }
        
        Text {
            text: root.text;
            color: #ffffff;
            vertical-alignment: center;
            font-size: 12px;
        }
    }
}

component IconButton inherits Rectangle {
    in property <string> text;
    in property <bool> primary: false;
    in property <bool> dark-mode;
    callback clicked();

    border-radius: 6px;
    background: primary ?
        (touch.pressed ? #0091E0 : (touch.has-hover ? #16a4fa : #0078D4)) : 
        (touch.pressed ? (root.dark-mode ? #333333 : #d0d0d0) : (touch.has-hover ? (root.dark-mode ? #3d3d3d : #e0e0e0) : (root.dark-mode ? #2d2d2d : #ffffff)));
    
    border-width: primary ? 0px : 1px;
    border-color: root.dark-mode ? #3d3d3d : #dcdcdc;

    animate background { duration: 100ms; }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding-left: 16px;
        padding-right: 16px;
        alignment: center;
        Text {
            text: root.text;
            font-family: "Segoe UI";
            color: primary ? #ffffff : (root.dark-mode ? #ffffff : #333333);
            font-weight: 600;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

// Filter chip component.
component FilterChip inherits Rectangle {
    in-out property <bool> checked;
    in property <string> text;
    in property <bool> dark-mode;
    callback toggled(bool);

    height: 28px;
    horizontal-stretch: 0; 
    border-radius: 14px;
    
    background: checked ? 
        #0078D4 : 
        (touch.has-hover ? (root.dark-mode ? #3d3d3d : #e0e0e0) : (root.dark-mode ? #2d2d2d : #f0f0f0));
        
    border-width: 1px;
    border-color: checked ? #0078D4 : (root.dark-mode ? #3d3d3d : #dcdcdc);

    animate background { duration: 150ms; }

    touch := TouchArea {
        clicked => {
            root.checked = !root.checked;
            root.toggled(root.checked);
        }
    }

    HorizontalLayout {
        padding-left: 12px;
        padding-right: 12px;
        spacing: 6px;

        // Vector checkmark (avoids font/emoji rendering issues).
        if (checked) : Path {
            width: 10px;
            height: 10px;
            viewbox-x: 0; viewbox-y: 0; viewbox-width: 10; viewbox-height: 10;
            stroke: white;
            stroke-width: 1.5px;
            commands: "M 1 5 L 4 8 L 9 2";
            y: (parent.height - self.height) / 2;
        }

        Text {
            text: root.text;
            color: checked ? #ffffff : (root.dark-mode ? #e6e6e6 : #555555);
            font-weight: checked ? 600 : 400;
            font-size: 12px;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

component ResultCard inherits Rectangle {
    in property <SearchResult> data;
    in property <bool> selected;
    in property <bool> dark-mode;
    
    callback clicked();
    callback open-folder();
    callback show-options(length, length);

    property <bool> card-hover: card-touch.has-hover || icon-touch.has-hover;

    background: selected ?
        (root.dark-mode ? #383838 : #e0e0e0) : (root.card-hover ? (root.dark-mode ? #2a2a2a : #f8f8f8) : transparent);
    border-radius: 6px;
    animate background { duration: 100ms; easing: ease-in-out; }

    HorizontalLayout {
        padding: 8px;
        spacing: 12px;

        // 1. Colored icon on the left
        Rectangle {
            width: 38px;
            height: 38px;
            background: data.icon_color;
            border-radius: 6px;

            icon-touch := TouchArea {
                clicked => { root.clicked(); }
            }

            Text {
                text: data.extension;
                color: white;
                font-weight: 700;
                font-size: 10px;
                vertical-alignment: center;
                horizontal-alignment: center;
            }
        }

        // 2. Zone texte principale (Nom + Chemin)
        Rectangle {
            horizontal-stretch: 1;
            card-touch := TouchArea {
                clicked => { root.clicked(); }
            }

            VerticalLayout {
                spacing: 2px;
                alignment: center; // Centre verticalement dans la carte

                // NOM DU FICHIER (Gros et clair)
                Text {
                    text: data.file_name;
                    color: root.dark-mode ? #ffffff : #111111;
                    font-size: 14px;
                    font-weight: 600;
                    overflow: elide;
                }

                // CHEMIN RELATIF (Petit et gris) en dessous
                HorizontalLayout {
                    spacing: 4px;
                    Text {
                        text: data.relative_path;
                        color: root.dark-mode ? #999999 : #666666;
                        font-size: 11px;
                        overflow: elide;
                        vertical-alignment: center;
                    }
                }

                // Extrait de code (si recherche de contenu)
                if (data.line_match != "") : VerticalLayout {
                    spacing: 4px;
                    
                    Rectangle {
                        background: root.dark-mode ? #1e1e1e : #f5f5f5;
                        border-radius: 4px;
                        HorizontalLayout {
                            padding: 4px;
                            Text {
                                text: data.line_match;
                                font-family: "Consolas";
                                font-size: 10px;
                                color: root.dark-mode ? #d4d4d4 : #333333;
                                overflow: elide;
                            }
                        }
                    }
                }
            }
        }

        // 3. Bouton Menu (...)
        menu-btn := Rectangle {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            background: options-touch.has-hover ? (root.dark-mode ? #505050 : #c0c0c0) : transparent;
            
            Text {
                text: "...";
                color: root.dark-mode ? #aaaaaa : #666666;
                font-size: 14px;
                font-weight: 900;
                vertical-alignment: center;
                horizontal-alignment: center;
                y: -4px;
            }

            options-touch := TouchArea {
                clicked => { 
                    root.show-options(self.mouse-x + self.absolute-position.x, self.mouse-y + self.absolute-position.y);
                }
            }
        }
    }
}

export component AppWindow inherits Window {
    title: "QuickFindr";
    icon: @image-url("../assets/icon.png");
    min-width: 900px;
    min-height: 650px;
    default-font-family: "Segoe UI"; // Sets the default system font
    
    in property <bool> dark-mode: true; 
    background: dark-mode ? #1e1e1e : #f9f9f9;

    in-out property <string> search-query: "";
    in-out property <string> current-path: "Select a folder...";
    in property <[SearchResult]> results: [];
    in property <string> status-text: "Ready";
    in property <int> active-threads: 0;
    
    in-out property <int> current-selection: -1;
    in-out property <bool> case-sensitive: false;
    in-out property <bool> use-regex: false;
    in-out property <bool> search-content: false;
    in-out property <bool> respect-gitignore: true;
    in-out property <string> exclude-extensions: "";
    in-out property <string> language-filter: "";
    in-out property <string> filter-category: "all";
    
    in-out property <bool> include-logs: false;
    in-out property <bool> include-binaries: false;
    in-out property <bool> include-temp: false;
    in-out property <bool> include-build: false;
    in-out property <bool> include-archives: false;

    // Automatically calculated property: contains the list of extensions to exclude
    // If a button is checked (true), return empty string to NOT exclude these files.
    // Otherwise, return the list of extensions to ban.
    private property <string> active-exclude-extensions: 
        (include-logs ? "" : ".log,") + 
        (include-binaries ? "" : ".exe,.dll,.so,.dylib,.class,.o,.obj,.pyc,") + 
        (include-temp ? "" : ".tmp,.temp,.cache,") + 
        (include-archives ? "" : ".zip,.tar,.gz,.rar");

    in property <int> total_results: 0;

    property <bool> menu-visible: false;
    property <bool> settings-visible: false;
    property <bool> favorites-visible: false;
    property <length> menu-x: 0px;
    property <length> menu-y: 0px;
    property <SearchResult> menu-item;
    
    in property <[FavoriteFolder]> favorites: [];
    in property <[FavoriteFolder]> recent-folders: [];
    
    callback request-search(string, bool, bool, bool, bool, string, string);
    callback open-item(SearchResult);
    callback open-item-folder(SearchResult);
    callback select-directory();
    callback select-favorite(string);
    callback add-to-favorites();
    callback remove-from-favorites(string);
    callback copy-item-path(SearchResult);
    callback copy-absolute-path(SearchResult);
    callback copy-relative-path(SearchResult);
    callback copy-filename(SearchResult);
    callback toggle-settings();
    callback clear-search();
    callback load-more-results();

    forward-focus: search-input;

    main-focus-scope := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.UpArrow) {
                root.current-selection = Math.max(0, root.current-selection - 1);
                return accept;
            }
            if (event.text == Key.DownArrow) {
                root.current-selection = Math.min(root.results.length - 1, root.current-selection + 1);
                return accept;
            }
            if (event.text == Key.Return) {
                 if (root.current-selection >= 0) { root.open-item(root.results[root.current-selection]); }
                 return accept;
            }
            if (event.text == Key.Escape) {
                if (root.menu-visible) {
                    root.menu-visible = false;
                    return accept;
                }
                search-input.text = "";
                root.search-query = "";
                return accept;
            }
            if (event.text == "o" && event.modifiers.control) {
                 if (root.current-selection >= 0) { root.open-item-folder(root.results[root.current-selection]); }
                 return accept;
            }
            if (event.text == "c" && event.modifiers.control) {
                 if (root.current-selection >= 0) { root.copy-absolute-path(root.results[root.current-selection]); }
                 return accept;
            }
            reject
        }

        VerticalLayout {
            padding: 0px;
            spacing: 0px;

            // HEADER
            Rectangle {
                background: root.dark-mode ? #252525 : #ffffff;
                drop-shadow-blur: 8px;
                drop-shadow-color: root.dark-mode ? #00000040 : #00000010;
                drop-shadow-offset-y: 2px;
                z: 10;
                
                VerticalLayout {
                    padding: 16px;
                    spacing: 12px;

                    // Ligne 1: Path & Settings
                    HorizontalLayout {
                        spacing: 12px;
                        alignment: space-between;

                        // Bouton dropdown favoris
                        Rectangle {
                            width: 36px;
                            height: 32px;
                            background: favorites-touch.has-hover ? (root.dark-mode ? #3d3d3d : #e0e0e0) : (root.dark-mode ? #2d2d2d : #f0f0f0);
                            border-radius: 6px;
                            border-width: 1px;
                            border-color: root.dark-mode ? #3d3d3d : #dcdcdc;
                            
                            Text {
                                text: "â­";
                                font-family: "Segoe UI Emoji";
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                font-size: 16px;
                            }
                            
                            favorites-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => { root.favorites-visible = !root.favorites-visible; }
                            }
                        }

                        Rectangle {
                            background: root.dark-mode ? #1e1e1e : #f5f5f5;
                            border-radius: 6px;
                            horizontal-stretch: 1;
                            height: 32px;
                            
                            HorizontalLayout {
                                padding-left: 8px;
                                padding-right: 8px;
                                spacing: 8px;
                                Text {
                                    text: "ðŸ“‚"; 
                                    font-family: "Segoe UI Emoji";
                                    vertical-alignment: center;
                                    font-size: 14px;
                                }
                                Text {
                                    text: root.current-path;
                                    color: root.dark-mode ? #cccccc : #666666;
                                    vertical-alignment: center;
                                    font-size: 12px;
                                    overflow: elide;
                                    horizontal-stretch: 1;
                                }
                                // Visual indicator that can be changed (chevron or discrete edit icon)
                                Text {
                                    text: "âœï¸";
                                    font-family: "Segoe UI Emoji";
                                    font-size: 10px;
                                    vertical-alignment: center;
                                    opacity: 0.5;
                                }
                            }
                            
                            // Zone cliquable par dessus tout le rectangle
                            TouchArea {
                                width: 100%;
                                height: 100%;
                                mouse-cursor: pointer;
                                clicked => { root.select-directory(); }
                            }
                        }

                        // Enhanced settings button
                        Rectangle {
                            width: 36px;
                            height: 32px;
                            background: settings-touch.has-hover ? (root.dark-mode ? #3d3d3d : #e0e0e0) : (root.dark-mode ? #2d2d2d : #f0f0f0);
                            border-radius: 6px;
                            border-width: 1px;
                            border-color: root.dark-mode ? #3d3d3d : #dcdcdc;
                            
                            // Animation de rotation au hover
                            animate background { duration: 150ms; }
                            
                            Text {
                                text: "âš™ï¸";
                                font-family: "Segoe UI Emoji";
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                font-size: 16px;
                            }
                            
                            settings-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => { root.settings-visible = !root.settings-visible; }
                            }
                        }
                    }

                    // Ligne 2: Barre de Recherche
                    HorizontalLayout {
                        height: 40px;
                        spacing: 10px;

                        search-input := LineEdit {
                            placeholder-text: "Rechercher un fichier ou du contenu...";
                            font-size: 14px;
                            horizontal-stretch: 1;
                            edited(text) => {
                                root.search-query = text;
                                root.current-selection = 0;
                                root.request-search(text, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter);
                            }
                            accepted => {
                                if (root.current-selection >= 0 && root.current-selection < root.results.length) {
                                     root.open-item(root.results[root.current-selection]);
                                }
                            }
                            key-pressed(event) => {
                                if (event.text == Key.DownArrow) {
                                    root.current-selection = Math.min(root.results.length - 1, root.current-selection + 1);
                                    return accept;
                                }
                                if (event.text == Key.UpArrow) {
                                    root.current-selection = Math.max(0, root.current-selection - 1);
                                    return accept;
                                }
                                reject
                            }
                        }

                        IconButton {
                            text: "SCAN";
                            primary: true;
                            dark-mode: root.dark-mode;
                            height: 40px;
                            width: 100px;
                            clicked => {
                                root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter);
                            }
                        }
                    }

                    // Ligne 3: Options & Filtres
                    HorizontalLayout {
                        spacing: 24px;
                        
                        HorizontalLayout {
                            spacing: 8px;
                            FilterChip { text: "Contenu"; dark-mode: root.dark-mode; checked <=> root.search-content; toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } }
                            FilterChip { text: "Casse"; dark-mode: root.dark-mode; checked <=> root.case-sensitive; toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } }
                            FilterChip { text: "Regex"; dark-mode: root.dark-mode; checked <=> root.use-regex; toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } }
                        }

                        Rectangle { width: 1px; background: root.dark-mode ? #3d3d3d : #e0e0e0; height: 20px; y: 4px; }

                        HorizontalLayout {
                            spacing: 8px;
                            Text {
                                text: "Inclure:";
                                color: root.dark-mode ? #888888 : #666666;
                                font-size: 11px;
                                vertical-alignment: center;
                            }

                            FilterChip { 
                                text: "Logs"; dark-mode: root.dark-mode; checked <=> root.include-logs;
                                toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } 
                            }
                            FilterChip { 
                                text: "Binaires"; dark-mode: root.dark-mode; checked <=> root.include-binaries;
                                toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } 
                            }
                            FilterChip { 
                                text: "Temp"; dark-mode: root.dark-mode; checked <=> root.include-temp;
                                toggled => { root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.active-exclude-extensions, root.language-filter); } 
                            }
                        }
                    }
                }
            }

            // CONTENU PRINCIPAL
            Rectangle {
                vertical-stretch: 1;
                clip: true;
                
                VerticalLayout {
                    padding: 16px;
                    
                    if (results.length > 0) : ListView {
                        for data[i] in results : ResultCard {
                            data: data;
                            selected: root.current-selection == i;
                            dark-mode: root.dark-mode;
                            clicked => {
                                root.current-selection = i;
                                root.open-item(data);
                            }
                            show-options(mouse-x, mouse-y) => {
                                root.menu-item = data;
                                root.menu-x = mouse-x - 220px;
                                root.menu-y = mouse-y;
                                root.menu-visible = true;
                            }
                        }
                    }

                    if (results.length < total_results) : IconButton {
                        text: "Charger plus";
                        dark-mode: root.dark-mode;
                        height: 36px;
                        width: 120px;
                        clicked => { root.load-more-results(); }
                    }
                    
                    if (results.length == 0) : VerticalLayout {
                        spacing: 16px;
                        alignment: center;
                        
                        // Professional icon (Vector magnifying glass)
                        Path {
                            width: 64px;
                            height: 64px;
                            viewbox-x: 0; viewbox-y: 0; viewbox-width: 24; viewbox-height: 24;
                            fill: root.dark-mode ? #333333 : #e0e0e0;
                            commands: "M 15.5 14 h -.79 l -.28 -.27 C 15.41 12.59 16 11.11 16 9.5 C 16 5.91 13.09 3 9.5 3 S 3 5.91 3 9.5 S 5.91 16 9.5 16 c 1.61 0 3.09 -.59 4.23 -1.57 l .27 .28 v .79 l 5 4.99 L 20.49 19 l -4.99 -5 Z m -6 0 C 7.01 14 5 11.99 5 9.5 S 7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14 Z";
                            x: (parent.width - self.width) / 2;
                        }

                        Text {
                            text: root.search-query == "" ? "QuickFindr" : "Aucun rÃ©sultat";
                            color: root.dark-mode ? #ffffff : #333333;
                            font-size: 24px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }
                        
                        Text {
                            text: root.search-query == "" ? 
                                "Commencez Ã  taper pour rechercher dans vos fichiers" : 
                                "Aucun fichier ne correspond Ã  vos critÃ¨res";
                            color: root.dark-mode ? #888888 : #666666;
                            font-size: 14px;
                            horizontal-alignment: center;
                        }
                    }
                }
            }

            // FOOTER
            Rectangle {
                height: 32px;
                background: root.dark-mode ? #252525 : #ffffff;
                
                Rectangle { height: 1px; width: 100%; y: 0px; background: root.dark-mode ? #333333 : #e0e0e0; }

                HorizontalLayout {
                    padding-left: 16px;
                    padding-right: 16px;
                    alignment: space-between;
                    
                    Text {
                        text: root.status-text;
                        font-size: 11px;
                        vertical-alignment: center;
                        color: root.dark-mode ? #999999 : #666666;
                    }
                    
                    Text {
                        text: "Threads actifs: " + root.active-threads;
                        font-size: 11px;
                        vertical-alignment: center;
                        color: root.dark-mode ? #666666 : #999999;
                    }
                }
            }
        }

        // --- POPUPS ---

        if (root.menu-visible) : TouchArea {
            width: 100%;
            height: 100%;
            z: 100;
            clicked => { root.menu-visible = false; }

            Rectangle {
                x: root.menu-x;
                y: root.menu-y;
                width: 220px;
                height: 108px;
                background: root.dark-mode ? #2d2d2d : #ffffff;
                border-radius: 8px;
                border-width: 1px;
                border-color: root.dark-mode ? #444444 : #cccccc;
                drop-shadow-blur: 16px;
                drop-shadow-color: #00000060;
                
                VerticalLayout {
                    padding: 4px;
                    spacing: 2px;
                    
                    MenuItem {
                        icon: "ðŸ“‹";
                        text: "Copier le chemin absolu";
                        clicked => { 
                            root.copy-absolute-path(root.menu-item);
                            root.menu-visible = false;
                        }
                    }
                    MenuItem {
                        icon: "ðŸ“„";
                        text: "Copier le chemin relatif";
                        clicked => { 
                            root.copy-relative-path(root.menu-item);
                            root.menu-visible = false;
                        }
                    }
                    MenuItem {
                        icon: "âœï¸";
                        text: "Copier le nom du fichier";
                        clicked => { 
                            root.copy-filename(root.menu-item);
                            root.menu-visible = false;
                        }
                    }
                }
            }
        }

        if (root.settings-visible) : TouchArea {
            width: 100%;
            height: 100%;
            z: 101;
            clicked => { root.settings-visible = false; }

            Rectangle {
                x: (root.width - 420px) / 2;
                y: (root.height - 350px) / 2;
                width: 420px;
                height: 350px;
                background: root.dark-mode ? #2d2d2d : #ffffff;
                border-radius: 12px;
                border-width: 1px;
                border-color: root.dark-mode ? #444444 : #cccccc;
                drop-shadow-blur: 32px;
                drop-shadow-color: #00000080;
                
                VerticalLayout {
                    padding: 24px;
                    spacing: 20px;

                    Text {
                        text: "ParamÃ¨tres";
                        font-family: "Segoe UI Emoji";
                        font-size: 20px;
                        font-weight: 700;
                        color: root.dark-mode ? #ffffff : #111111;
                    }

                    Rectangle { height: 1px; background: root.dark-mode ? #444444 : #e0e0e0; }

                    VerticalLayout {
                        spacing: 16px;
                        
                        HorizontalLayout {
                            spacing: 12px;
                            Text {
                                text: "Ignorer les fichiers (.gitignore)";
                                color: root.dark-mode ? #e6e6e6 : #333333;
                                font-size: 14px;
                                vertical-alignment: center;
                                horizontal-stretch: 1;
                            }

                            FilterChip {
                                text: root.respect-gitignore ? "OUI" : "NON";
                                checked <=> root.respect-gitignore;
                                dark-mode: root.dark-mode;
                                toggled => {
                                    root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter);
                                }
                            }
                        }

                        Text {
                            text: "Filtres rapides par langage";
                            color: root.dark-mode ? #aaaaaa : #666666;
                            font-size: 12px;
                            font-weight: 600;
                        }

                        HorizontalLayout {
                            spacing: 8px;
                            IconButton { text: "Java"; dark-mode: root.dark-mode; height: 32px; clicked => { root.language-filter = "java"; root.exclude-extensions = ".class,.jar,.war"; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } }
                            IconButton { text: "Python"; dark-mode: root.dark-mode; height: 32px; clicked => { root.language-filter = "python"; root.exclude-extensions = ".pyc,.pyo,__pycache__"; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } }
                            IconButton { text: "JS / TS"; dark-mode: root.dark-mode; height: 32px; clicked => { root.language-filter = "javascript"; root.exclude-extensions = "node_modules,.min.js"; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } }
                            IconButton { text: "Rust"; dark-mode: root.dark-mode; height: 32px; clicked => { root.language-filter = "rust"; root.exclude-extensions = "target,.rlib"; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } }
                        }

                        HorizontalLayout {
                            spacing: 8px;
                            IconButton { text: "C++"; dark-mode: root.dark-mode; height: 32px; clicked => { root.language-filter = "cpp"; root.exclude-extensions = ".o,.obj,.exe,.dll"; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } }
                            
                            Rectangle { horizontal-stretch: 1; }
                            
                            IconButton { 
                                text: "Reset"; dark-mode: root.dark-mode; height: 32px; 
                                clicked => { root.language-filter = ""; root.exclude-extensions = ""; root.request-search(root.search-query, root.case-sensitive, root.use-regex, root.search-content, root.respect-gitignore, root.exclude-extensions, root.language-filter); } 
                            }
                        }
                    }

                    Rectangle { vertical-stretch: 1; }

                    IconButton {
                        text: "Fermer";
                        primary: true;
                        dark-mode: root.dark-mode;
                        height: 36px;
                        clicked => { root.settings-visible = false; }
                    }
                }
            }
        }

        // Menu Favoris (Dropdown)
        if (root.favorites-visible) : Rectangle {
            width: 100%;
            height: 100%;
            
            TouchArea {
                clicked => { root.favorites-visible = false; }
            }

            Rectangle {
                x: 16px;
                y: 50px;
                width: 320px;
                height: 450px;
                background: root.dark-mode ? #2d2d2d : #ffffff;
                border-radius: 8px;
                border-width: 1px;
                border-color: root.dark-mode ? #444444 : #cccccc;
                drop-shadow-blur: 16px;
                drop-shadow-color: #00000040;
                
                VerticalLayout {
                    padding: 8px;
                    spacing: 4px;

                    // Header avec bouton "Ajouter aux favoris"
                    HorizontalLayout {
                        padding: 8px;
                        spacing: 8px;
                        
                        Text {
                            text: "Favorites & Recents";
                            color: root.dark-mode ? #ffffff : #111111;
                            font-size: 14px;
                            font-weight: 700;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }
                        
                        Rectangle {
                            width: 28px;
                            height: 28px;
                            border-radius: 4px;
                            background: add-fav-touch.has-hover ? (root.dark-mode ? #3d3d3d : #e0e0e0) : transparent;
                            
                            Text {
                                text: "âž•";
                                font-family: "Segoe UI Emoji";
                                font-size: 14px;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            add-fav-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => { 
                                    root.add-to-favorites();
                                    root.favorites-visible = false;
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: root.dark-mode ? #444444 : #e0e0e0; }

                    ScrollView {
                        height: 380px;
                        
                        VerticalLayout {
                            spacing: 2px;
                            alignment: start;
                            
                            // Favoris
                            if (root.favorites.length > 0) : VerticalLayout {
                                spacing: 2px;
                                
                                for fav in root.favorites : Rectangle {
                                    height: 36px;
                                    background: fav-touch.has-hover ? (root.dark-mode ? #383838 : #f0f0f0) : transparent;
                                    border-radius: 4px;
                                    
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 8px;
                                        
                                        Text {
                                            text: "â­";
                                            font-family: "Segoe UI Emoji";
                                            font-size: 14px;
                                            vertical-alignment: center;
                                        }
                                        
                                        VerticalLayout {
                                            spacing: 2px;
                                            horizontal-stretch: 1;
                                            
                                            Text {
                                                text: fav.name;
                                                color: root.dark-mode ? #ffffff : #111111;
                                                font-size: 12px;
                                                font-weight: 600;
                                                overflow: elide;
                                            }
                                            
                                            Text {
                                                text: fav.path;
                                                color: root.dark-mode ? #999999 : #666666;
                                                font-size: 10px;
                                                overflow: elide;
                                            }
                                        }
                                        
                                        Rectangle {
                                            width: 32px;
                                        }
                                    }
                                    
                                    fav-touch := TouchArea {
                                        width: parent.width - 32px;
                                        height: parent.height;
                                        mouse-cursor: pointer;
                                        clicked => { 
                                            root.select-favorite(fav.path);
                                            root.favorites-visible = false;
                                        }
                                    }
                                    
                                    Rectangle {
                                        x: parent.width - 32px;
                                        y: 0px;
                                        width: 24px;
                                        height: 24px;
                                        border-radius: 4px;
                                        background: remove-touch.has-hover ? (root.dark-mode ? #ff4444 : #ffcccc) : transparent;
                                        
                                        Text {
                                            text: "ðŸ—‘ï¸";
                                            font-family: "Segoe UI Emoji";
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: center;
                                        }
                                        
                                        remove-touch := TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => { 
                                                root.remove-from-favorites(fav.path);
                                            }
                                        }
                                    }
                                }
                            
                            // Separator if both lists exist
                            if (root.favorites.length > 0 && root.recent-folders.length > 0) : Rectangle {
                                height: 16px;
                                
                                Rectangle {
                                    y: 7px;
                                    height: 1px;
                                    background: root.dark-mode ? #444444 : #e0e0e0;
                                }
                            }
                            
                            // Recents
                            if (root.recent-folders.length > 0) : VerticalLayout {
                                spacing: 2px;
                                
                                VerticalLayout {
                                    padding-left: 8px;
                                    padding-top: 4px;
                                    padding-bottom: 4px;
                                    spacing: 0px;
                                    
                                    Text {
                                        text: "Recents";
                                        color: root.dark-mode ? #999999 : #666666;
                                        font-size: 11px;
                                        font-weight: 600;
                                    }
                                }
                                
                                for recent in root.recent-folders : Rectangle {
                                            height: 32px;
                                            background: recent-touch.has-hover ? (root.dark-mode ? #383838 : #f0f0f0) : transparent;
                                            border-radius: 4px;
                                            
                                            HorizontalLayout {
                                                padding-left: 8px;
                                                padding-right: 8px;
                                                spacing: 8px;
                                                
                                                Text {
                                                    text: "ðŸ•’";
                                                    font-family: "Segoe UI Emoji";
                                                    font-size: 12px;
                                                    vertical-alignment: center;
                                                }
                                                
                                                VerticalLayout {
                                                    spacing: 2px;
                                                    horizontal-stretch: 1;
                                                    
                                                    Text {
                                                        text: recent.name;
                                                        color: root.dark-mode ? #cccccc : #333333;
                                                        font-size: 11px;
                                                        overflow: elide;
                                                    }
                                                    
                                                    Text {
                                                        text: recent.path;
                                                        color: root.dark-mode ? #888888 : #888888;
                                                        font-size: 9px;
                                                        overflow: elide;
                                                    }
                                                }
                                            }
                                            
                                            recent-touch := TouchArea {
                                                mouse-cursor: pointer;
                                                clicked => { 
                                                    root.select-favorite(recent.path);
                                                    root.favorites-visible = false;
                                                }
                                            }
                                        }
                            }
                            
                            // Message si vide
                            if (root.favorites.length == 0 && root.recent-folders.length == 0) : Rectangle {
                                height: 80px;
                                
                                VerticalLayout {
                                    alignment: center;
                                    spacing: 8px;
                                    
                                    Text {
                                        text: "No favorites";
                                        color: root.dark-mode ? #666666 : #999999;
                                        font-size: 12px;
                                        horizontal-alignment: center;
                                    }
                                    
                                    Text {
                                        text: "Click âž• to add";
                                        color: root.dark-mode ? #555555 : #aaaaaa;
                                        font-size: 10px;
                                        horizontal-alignment: center;
                                    }
                                }
                            }
                        }
}
}
}
}
}
}
}
